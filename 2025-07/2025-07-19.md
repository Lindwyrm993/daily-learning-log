# 19/JUL/2025 

## Librería `hmac` en Python

La librería `hmac` es parte de la biblioteca estándar de Python y permite crear códigos de autenticación de mensajes (HMAC - [Hash-based Message Authentication Code]), los cuales verifican la **integridad** y **autenticidad** de un mensaje una función hash y una clave secreta. Comúnmente utilizada en sistemas de autentificación, validación de datos y firmas digitales.

### Importación

Se importa directamente:
```python
import hmac
import hashlib
```

### Funcionalidades principales

#### 1. Generar un código HMAC(`hmac.new()` + `digest()` / `hexdigest()`)

Crea un código HMAC a partir de un mensaje y una clave secreta, utilizando una función hash (por ejemplo `sha256`).
```python
clave = b"clave_segura"
mensaje = b"Este es un mensaje confidencial"

codigo = hmac.new(clave, mensaje, hashlib.sha256)
print("Digest (hex):", codigo.hexdigest())
```

#### 2. Verificar un HMAC con `hmac.compare_digest()`

Permite comparar dos códigos HMAC de forma segura, evitando ataques de temporización.
```python
clave = b"clave_segura"
mensaje = b"Este es un mensaje confidencial"

original = hmac.new(clave, mensaje, hashlib.sha256).digest()
recibido = hmac.new(clave, mensaje, hashlib.sha256).digest()

if hmac.compare_digest(original, recibido):
  print("HMAC Válido)
else:
  print("HMAC Inválido)
```

### Usos comunes de `hmac`

#### 1. Firmar y verificar tokens de autenticación

Utilizado para firmar tokens que contienen datos de usuarios.
```python
import base64
clave = b"clave_secreta"
payload = b"user_id=42&role=admin"

firma = hmac.new(clave, hashlib.sha256).diges()
token = base64.urlsafe_b64encode(payload + b"." + firma)

print("Token firmado:", token)
```

#### 2. Validación de Webhooks en APIs

Los servicios externos (como GitHub o Stripe) firman los mensajes con HMAC. Se puede validar esa firma localmente.
```python
clave = b"webhook_secret"
mensaje = b"evento=pago&monto = 100.00"

firma_servicio = hmac.new(clave, mensaje, hashlib.sha256).hexdigest()
firma_local = hmac.new(clave, mensaje, hashlib.sha256).hexdigest()

if hmac.compare_digest(firma_servicio, firma_local):
  print("Webhook autenticado")
```

#### 3. Verificar integridad de archivos

Se puede usar HMAC para detectar si un archivo ha sido alterado.
```python
def generar_hmac(path_archivo, clave):
    with open(path_archivo, 'rb') as f:
        datos = f.read()
    return hmac.new(clave, datos, hashlib.sha256).hexdigest()

clave = b"clave_supersecreta"
digest1 = generar_hmac("datos.csv", clave)
digest2 = generar_hmac("datos.csv", clave)

if hmac.compare_digest(digest1, digest2):
    print("Archivo íntegro")
else:
    print("Archivo modificado")
```

#### 4. Firmar parámetros en pagos

Utilizado para firmar cadenas de parámetros en plataformas de pago.
```python
parametros = b"monto=100&moneda=MXN&orden=123"
clave_api = b"mi_clave_privada"
firma = hmac.new(clave_api, parametros, hashlib.sha256).hexdigest()

print("Firma de pago:", firma)
```

### Buenas prácticas al usar `hmac`

- Usar funciones hash seguras como `sha256` o `sha3_256`.
- Almacenar claves en variables de entorno, no en texto plano.
- Usar `compare_digest()` para evitar **Timing Attacks**.
- Cambiar o rotar claves secretas de forma periódica.
- Documentar de manera clara qué datos se firman y en qué orden.

---

















